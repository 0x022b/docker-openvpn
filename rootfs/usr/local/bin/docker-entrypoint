#!/bin/sh
user='openvpn'
uid="${HOST_UID:-65534}"
gid="${HOST_GID:-65534}"
config="/data/${OPENVPN_CLIENT_CONFIG:-config.ovpn}"
passwd="/data/${OPENVPN_AUTH_USER_PASS:-login.conf}"

'/bin/cat' \
	'/etc/iptables/default-policy' \
| '/sbin/iptables-restore'

if [ "$?" -ne 0 ]; then
	exit 1
fi

if [ $('/sbin/ip' -6 route list | '/usr/bin/wc' -l) -gt 0 ]; then
	'/bin/cat' \
		'/etc/iptables/default-policy' \
	| '/sbin/ip6tables-restore'

	if [ "$?" -ne 0 ]; then
		exit 1
	fi
fi

if ! '/usr/bin/getent' group "${gid}"; then
	'/usr/sbin/addgroup' -g "${gid}" -S "${user}"
fi

if ! '/usr/bin/getent' passwd "${uid}"; then
	'/usr/sbin/adduser' -h "/tmp/${user}" -g "${user}" -s '/sbin/nologin' \
		-G "${user}" -SD -u "${uid}" "${user}"
fi

if [ ! -e "${config}" ]; then
	echo 'OpenVPN client configuration missing'
	exit 1
fi

proto=$('/usr/bin/awk' '/proto / { print $2 }' "${config}")
host=$('/usr/bin/awk' '/remote / { print $2 }' "${config}")
port=$('/usr/bin/awk' '/remote / { print $3 }' "${config}")

'/bin/sed' "s/{PROTO}/${proto}/g; s/{HOST}/${host}/g; s/{PORT}/${port}/g" \
	'/etc/iptables/ipv4-default' \
	'/etc/iptables/ipv4-custom' \
| '/sbin/iptables-restore' --noflush

if [ "$?" -ne 0 ]; then
	exit 1
fi

if [ -n "${CONTAINER_GATEWAY:+x}" ]; then
	gateway=$('/usr/bin/getent' hosts "${CONTAINER_GATEWAY}")
	if [ "$?" -ne "0" ]; then
		echo "getent: Unknown host: ${CONTAINER_GATEWAY}"
		exit 1
	fi
	gateway=$(echo "${gateway}" | '/usr/bin/awk' '{ print $1 }')

	if ! '/sbin/ip' route replace default via "${gateway}"; then
		exit 1
	fi
fi

if [ -n "${ENABLE_FORWARDING:+x}" ]; then
	'/bin/cat' \
		'/etc/iptables/ipv4-forward' \
	| '/sbin/iptables-restore' --noflush

	if [ "$?" -ne 0 ]; then
		exit 1
	fi
fi

if ! '/usr/sbin/openvpn' --mktun --dev 'tun0' --dev-type 'tun'; then
	exit 1
fi

if [ "$1" == 'container-daemon' ]; then
	set -- '/usr/sbin/openvpn' --config "${config}" \
		--auth-user-pass "${passwd}" --auth-nocache \
		--dev 'tun0' --persist-tun --iproute '/usr/sbin/ip-su' \
		--mute-replay-warnings
fi

exec '/sbin/su-exec' "${uid}:${gid}" "$@"
